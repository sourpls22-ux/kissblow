#!/usr/bin/env node

import { createBackup, cleanupOldBackups, getBackupDirSize } from '../bot/backupService.js'
import fs from 'fs'
import path from 'path'
import { fileURLToPath } from 'url'

const __filename = fileURLToPath(import.meta.url)
const __dirname = path.dirname(__filename)

console.log('üîÑ KissBlow Backup Script')
console.log('========================')

async function main() {
  try {
    console.log('üìÖ –í—Ä–µ–º—è:', new Date().toLocaleString('ru-RU'))
    console.log('üìÅ –†–∞–±–æ—á–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è:', process.cwd())
    
    // –°–æ–∑–¥–∞–µ–º –±–µ–∫–∞–ø
    console.log('\nüîÑ –°–æ–∑–¥–∞—é –±–µ–∫–∞–ø...')
    const backupPath = await createBackup()
    
    if (backupPath) {
      const stats = fs.statSync(backupPath)
      console.log(`‚úÖ –ë–µ–∫–∞–ø —Å–æ–∑–¥–∞–Ω: ${backupPath}`)
      console.log(`üíæ –†–∞–∑–º–µ—Ä: ${(stats.size / 1024 / 1024).toFixed(2)} MB`)
      
      // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –±–µ–∫–∞–ø—ã
      console.log('\nüóëÔ∏è –û—á–∏—â–∞—é —Å—Ç–∞—Ä—ã–µ –±–µ–∫–∞–ø—ã...')
      cleanupOldBackups(7)
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
      const totalSize = getBackupDirSize()
      console.log(`üìä –û–±—â–∏–π —Ä–∞–∑–º–µ—Ä –±–µ–∫–∞–ø–æ–≤: ${(totalSize / 1024 / 1024).toFixed(2)} MB`)
      
      console.log('\n‚úÖ –°–∫—Ä–∏–ø—Ç –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!')
    } else {
      console.log('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –±–µ–∫–∞–ø–∞')
      process.exit(1)
    }
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞:', error.message)
    process.exit(1)
  }
}

// –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∫—Ä–∏–ø—Ç
main()
