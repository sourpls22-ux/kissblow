import fs from 'fs-extra'
import archiver from 'archiver'
import path from 'path'
import { fileURLToPath } from 'url'

const __filename = fileURLToPath(import.meta.url)
const __dirname = path.dirname(__filename)

const PROJECT_ROOT = path.join(__dirname, '..')
const BACKUP_DIR = path.join(PROJECT_ROOT, '..', 'backups')

// –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É –¥–ª—è –±–µ–∫–∞–ø–æ–≤ –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
if (!fs.existsSync(BACKUP_DIR)) {
  fs.mkdirSync(BACKUP_DIR, { recursive: true })
}

export async function createBackup() {
  const timestamp = new Date().toISOString().replace(/[:.]/g, '-')
  const backupFileName = `kissblow-backup-${timestamp}.zip`
  const backupPath = path.join(BACKUP_DIR, backupFileName)
  
  console.log(`üîÑ –°–æ–∑–¥–∞—é –±–µ–∫–∞–ø: ${backupFileName}`)
  
  try {
    // –°–æ–∑–¥–∞–µ–º ZIP –∞—Ä—Ö–∏–≤
    const output = fs.createWriteStream(backupPath)
    const archive = archiver('zip', { zlib: { level: 9 } })
    
    return new Promise((resolve, reject) => {
      output.on('close', () => {
        console.log(`‚úÖ –ë–µ–∫–∞–ø —Å–æ–∑–¥–∞–Ω: ${backupPath} (${archive.pointer()} bytes)`)
        resolve(backupPath)
      })
      
      archive.on('error', (err) => {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏—è:', err)
        reject(err)
      })
      
      archive.pipe(output)
      
      // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∞–π–ª—ã –≤ –∞—Ä—Ö–∏–≤
      addFilesToArchive(archive)
      
      // –ó–∞–≤–µ—Ä—à–∞–µ–º –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏–µ
      archive.finalize()
    })
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –±–µ–∫–∞–ø–∞:', error)
    throw error
  }
}

function addFilesToArchive(archive) {
  console.log('üìÅ –î–æ–±–∞–≤–ª—è—é —Ñ–∞–π–ª—ã –≤ –∞—Ä—Ö–∏–≤...')
  
  // 1. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö SQLite
  const dbPath = path.join(PROJECT_ROOT, 'database.sqlite')
  if (fs.existsSync(dbPath)) {
    console.log('  üìÑ database.sqlite')
    archive.file(dbPath, { name: 'database.sqlite' })
  } else {
    console.log('  ‚ö†Ô∏è database.sqlite –Ω–µ –Ω–∞–π–¥–µ–Ω')
  }
  
  // 2. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
  const configDir = path.join(PROJECT_ROOT, 'config')
  if (fs.existsSync(configDir)) {
    console.log('  üìÅ config/')
    archive.directory(configDir, 'config')
  }
  
  // 3. –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (—Ç–æ–ª—å–∫–æ –ø—Ä–∏–º–µ—Ä—ã, –Ω–µ —Ä–µ–∞–ª—å–Ω—ã–µ)
  const envExample = path.join(PROJECT_ROOT, 'env.example')
  if (fs.existsSync(envExample)) {
    console.log('  üìÑ env.example')
    archive.file(envExample, { name: 'env.example' })
  }
  
  const envProdExample = path.join(PROJECT_ROOT, 'env.production.example')
  if (fs.existsSync(envProdExample)) {
    console.log('  üìÑ env.production.example')
    archive.file(envProdExample, { name: 'env.production.example' })
  }
  
  // 4. –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
  const packageJson = path.join(PROJECT_ROOT, 'package.json')
  if (fs.existsSync(packageJson)) {
    console.log('  üìÑ package.json')
    archive.file(packageJson, { name: 'package.json' })
  }
  
  const ecosystemConfig = path.join(PROJECT_ROOT, '..', 'ecosystem.config.cjs')
  if (fs.existsSync(ecosystemConfig)) {
    console.log('  üìÑ ecosystem.config.cjs')
    archive.file(ecosystemConfig, { name: 'ecosystem.config.cjs' })
  }
  
  // 5. –õ–æ–≥–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å)
  const logsDir = path.join(PROJECT_ROOT, '..', 'logs')
  if (fs.existsSync(logsDir)) {
    console.log('  üìÅ logs/')
    archive.directory(logsDir, 'logs')
  }
  
  // 6. –°–∫—Ä–∏–ø—Ç—ã
  const scriptsDir = path.join(PROJECT_ROOT, 'scripts')
  if (fs.existsSync(scriptsDir)) {
    console.log('  üìÅ scripts/')
    archive.directory(scriptsDir, 'scripts')
  }
  
  // 7. –°–µ—Ä–≤–∏—Å—ã
  const servicesDir = path.join(PROJECT_ROOT, 'services')
  if (fs.existsSync(servicesDir)) {
    console.log('  üìÅ services/')
    archive.directory(servicesDir, 'services')
  }
  
  // 8. –ú–∞—Ä—à—Ä—É—Ç—ã
  const routesDir = path.join(PROJECT_ROOT, 'routes')
  if (fs.existsSync(routesDir)) {
    console.log('  üìÅ routes/')
    archive.directory(routesDir, 'routes')
  }
  
  // 9. –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–∏—Å—Ç–µ–º–µ
  const systemInfo = {
    timestamp: new Date().toISOString(),
    nodeVersion: process.version,
    platform: process.platform,
    arch: process.arch,
    uptime: process.uptime(),
    memoryUsage: process.memoryUsage(),
    env: process.env.NODE_ENV || 'development'
  }
  
  console.log('  üìÑ system-info.json')
  archive.append(JSON.stringify(systemInfo, null, 2), { name: 'system-info.json' })
  
  console.log('‚úÖ –í—Å–µ —Ñ–∞–π–ª—ã –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ –∞—Ä—Ö–∏–≤')
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ —Å—Ç–∞—Ä—ã—Ö –±–µ–∫–∞–ø–æ–≤
export function cleanupOldBackups(maxBackups = 7) {
  try {
    if (!fs.existsSync(BACKUP_DIR)) {
      return
    }
    
    const files = fs.readdirSync(BACKUP_DIR)
      .filter(file => file.startsWith('kissblow-backup-') && file.endsWith('.zip'))
      .map(file => ({
        name: file,
        path: path.join(BACKUP_DIR, file),
        stats: fs.statSync(path.join(BACKUP_DIR, file))
      }))
      .sort((a, b) => b.stats.mtime - a.stats.mtime)
    
    if (files.length > maxBackups) {
      const filesToDelete = files.slice(maxBackups)
      console.log(`üóëÔ∏è –£–¥–∞–ª—è—é ${filesToDelete.length} —Å—Ç–∞—Ä—ã—Ö –±–µ–∫–∞–ø–æ–≤...`)
      
      filesToDelete.forEach(file => {
        fs.unlinkSync(file.path)
        console.log(`  üóëÔ∏è –£–¥–∞–ª–µ–Ω: ${file.name}`)
      })
    }
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ —Å—Ç–∞—Ä—ã—Ö –±–µ–∫–∞–ø–æ–≤:', error)
  }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –ø–∞–ø–∫–∏
export function getBackupDirSize() {
  try {
    if (!fs.existsSync(BACKUP_DIR)) {
      return 0
    }
    
    const files = fs.readdirSync(BACKUP_DIR)
    let totalSize = 0
    
    files.forEach(file => {
      const filePath = path.join(BACKUP_DIR, file)
      const stats = fs.statSync(filePath)
      totalSize += stats.size
    })
    
    return totalSize
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –ø–∞–ø–∫–∏ –±–µ–∫–∞–ø–æ–≤:', error)
    return 0
  }
}
