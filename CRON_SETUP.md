# Настройка автоматического списания подписок

Для автоматического списания $1 каждые 24 часа нужно настроить вызов специального endpoint.

## Какой вариант выбрать?

**Если сайт на VPS (ваш сервер):**
- ✅ **Рекомендуется: Вариант 2** (внешний cron сервис) - самый простой
- Альтернатива: Вариант 3 (системный cron на сервере)

**Если сайт на Vercel:**
- Используйте Вариант 1 (Vercel Cron)

---

## Вариант 2: Внешний cron сервис (РЕКОМЕНДУЕТСЯ)

Это самый простой способ. Используйте бесплатный сервис для автоматических запросов.

### Шаги настройки:

1. **Зарегистрируйтесь на одном из сервисов:**
   - https://cron-job.org (бесплатно)
   - https://crontab.guru/cron-job (бесплатно)
   - https://www.easycron.com (есть бесплатный план)

2. **Создайте новый cron job с такими параметрами:**

   - **URL**: `https://kissblow.me/api/cron/check-profile-subscriptions`
   - **Метод**: `GET`
   - **Заголовки (Headers)**:
     ```
     Authorization: Bearer ваш_секретный_ключ
     ```
   - **Расписание**: `0 * * * *` (каждый час в начале часа)
   - **Название**: "Check Profile Subscriptions"

3. **Сгенерируйте секретный ключ:**

   Откройте `.env` файл на сервере и добавьте:
   ```env
   CRON_SECRET="ваш_случайный_секрет_здесь_например_abc123xyz789"
   ```
   
   Или сгенерируйте случайную строку онлайн: https://randomkeygen.com/
   
   **Важно**: Используйте один и тот же секрет в `.env` файле и в заголовке Authorization на cron сервисе!

4. **Сохраните настройки cron job**

5. **Проверьте работу:**
   
   Можете протестировать вручную, открыв в браузере:
   ```
   https://kissblow.me/api/cron/check-profile-subscriptions
   ```
   
   Должна быть ошибка "Unauthorized" (это нормально, так как нет заголовка Authorization).
   
   Или используйте curl для теста:
   ```bash
   curl -H "Authorization: Bearer ваш_секретный_ключ" https://kissblow.me/api/cron/check-profile-subscriptions
   ```

---

## Вариант 3: Системный cron на сервере

Если у вас есть доступ к серверу по SSH.

### Шаги настройки:

1. **Подключитесь к серверу по SSH**

2. **Добавьте переменную CRON_SECRET в .env:**
   ```env
   CRON_SECRET="ваш_случайный_секрет"
   ```

3. **Откройте crontab для редактирования:**
   ```bash
   crontab -e
   ```

4. **Добавьте строку:**
   ```bash
   0 * * * * curl -H "Authorization: Bearer ваш_секретный_ключ" https://kissblow.me/api/cron/check-profile-subscriptions >/dev/null 2>&1
   ```

5. **Сохраните и выйдите** (в nano: Ctrl+X, затем Y, затем Enter)

6. **Проверьте, что cron job добавлен:**
   ```bash
   crontab -l
   ```

---

## Вариант 1: Vercel Cron (только если сайт на Vercel)

Если ваш сайт размещен на Vercel.

1. **Создайте файл `vercel.json` в корне проекта:**
   ```json
   {
     "crons": [{
       "path": "/api/cron/check-profile-subscriptions",
       "schedule": "0 * * * *"
     }]
   }
   ```

2. **Добавьте переменную окружения CRON_SECRET в настройках Vercel проекта**

3. **Задеплойте проект заново**

---

## Важно!

1. **Не забудьте установить `CRON_SECRET` в `.env` файле** - это защищает endpoint от несанкционированного доступа

2. **Расписание `0 * * * *`** означает выполнение каждый час в начале часа (00:00, 01:00, 02:00 и т.д.)

3. **Проверка будет работать автоматически** - каждый час система проверит все активные профили и спишет $1 тем, у кого прошло 24 часа с последнего платежа




